<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>blipweb [alpha]: patch editing and sharing for meeblip anode</title>
  <meta name="description" content="MeeBlip Anode Web MIDI Patch Editor">
  <meta name="author" content="Factotumo">

  <link rel="stylesheet" href="./s.css">
  <link href="./jquery-ui.css" rel="stylesheet">
  
  <script src="./jquery-2.1.4.js" type="text/javascript"></script>
  <script src="./jsrender.js" type="text/javascript"></script>
  <script src="./jquery.knob.min.js" type="text/javascript"></script>
  <script src="./jquery-ui.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="./index.js"></script>

</head>

<body>

  <div id="container">
  
  <p><b>blipweb [alpha]</b>: patch editing and sharing for meeblip anode.

  <b>examples</b>: <a href="/blipweb/?aDecay=43&fDecay=25&sustain=0&fCut=64&wave=52&detune=64&octave=0&lDepth=122&lRate=120&lDest=0">perc<a> - <a href="/blipweb/?aDecay=45&fDecay=97&sustain=127&fCut=19&wave=13&detune=63&octave=0&lDepth=108&lRate=12&lDest=127">grit</a></p>

  <form id="editor" name="editor">
  
  <div id="controlBar">
  <b>MIDI: ports</b>
  <select name="port" id="port">
    <option value="none">none</option>
  </select>
  
  <b>channels</b>
  <select name="channel" id="channel">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
  </select>
  &nbsp;
  <input type="submit" id="send" name="send" value="send to meeblip" class="controlButton" />
  <input type="submit" id="share" name="share" value="get patch link" class="controlButton" />

  <div id="shareUrl" title="link for current settings" style="display:none">&nbsp;</div>
  </div>  


  <div id="envelope" class="knobGroup">
    <h2>envelope</h2>
    <div class="knobLabelPair">
      
      <h3>amp. decay</h3>
      <input name="aDecay" type="text" class="dial" value="64" />
      
    </div>
    <div class="knobLabelPair">
      
      <h3>filter decay</h3>
      <input name="fDecay" type="text" class="dial" value="64" />
      
    </div>

    <div id="sustain" class="knobLabelPair">
      <h3>sustain</h3>
      <input type="radio" id="sustain1" name="sustain" value="0"><label for="sustain1">off</label>
      <input type="radio" id="sustain2" name="sustain" checked="checked" value="127"><label for="sustain2">on</label>
    </div>
  </div>

  <div id="filter" class="knobGroup">
    <h2>filter</h2>
    <div class="knobLabelPair">
    
      <h3>cutoff</h3>
      <input name="fCut" type="text" class="dial" value="64" />
      
    </div>
  </div>

  <div class="clear">&nbsp;</div>

  <div id="oscillators" class="knobGroup">
    <h2>oscillators</h2>
    <div class="knobLabelPair">
      
      <h3>wave</h3>
      <input name="wave" type="text" class="dial" value="64" />
      
    </div>

    <div class="knobLabelPair">
      
      <h3>detune</h3>
      <input name="detune" type="text" class="dial" value="64"/>
      
    </div>

    <div id="octave" class="knobLabelPair">
      <h3>octave</h3>
      <input type="radio" id="octave1" name="octave" value="0"><label for="octave1">down</label>
      <input type="radio" id="octave2" name="octave" checked="checked" value="127"><label for="octave2">up</label>
    </div>
  </div>

  <div id="lfo" class="knobGroup">
    <h2>lfo</h2>
    <div class="knobLabelPair">
      
      <h3>rate</h3>
      <input name="lDepth" type="text" class="dial" value="64" />
      
    </div>

    <div class="knobLabelPair">
      
      <h3>depth</h3>
      <input name="lRate" type="text" class="dial" value="64"/>
      
    </div>

    <div id="lDest" class="knobLabelPair">
      <h3>dest</h3>
      <input type="radio" id="lDest1" name="lDest" value="0"><label for="lDest1">osc</label>
      <input type="radio" id="lDest2" name="lDest" checked="checked" value="127"><label for="lDest2">filter</label>
    </div>
  </div>
  </form>
  
<script type="text/javascript">

    var uri = document.documentURI;
    var queryIdx = uri.indexOf("?");
    if (queryIdx != -1) {
      var query = uri.substr(queryIdx+1, uri.length-1);
      var nameValPairs = query.split("&");
      for (var i = 0; i < nameValPairs.length; i++) {
        var nameValue = nameValPairs[i].split("=");
        //console.log(nameValue);
        document.forms["editor"].elements[nameValue[0]].value = nameValue[1];
      }
    }

    $(function() {
        $(".dial").knob(
          {
              'min':0,
              'max':127,
              'width': '70',
              'height': '100',
              'cursor': false,
              'thickness': .3,
              'angleOffset': -150,
              'angleArc': 300,
              'fgColor': '#222222'
          }
        );
        $("#sustain").buttonset();
        $("#octave").buttonset();
        $("#lDest").buttonset();
        
        $("editor").keypress(
          function(e) {
            if (e.which == 13) {
              $("#send").click();
              return false;
            }
          }
        );

        $("#send").button().click(
          function(event) {
            //console.log(event);
            var f = document.forms["editor"];

            var selectedPort = f.elements["port"][f.elements["port"].selectedIndex];
            var selectedChannel = parseInt(f.elements["channel"][f.elements["channel"].selectedIndex].text);
            var status = 176 + (selectedChannel - 1);
            console.log("out port = " + selectedPort.text + ", status = " + status);
            

            for (var i = 0; i < f.elements.length; i++) {
                var e = f.elements[i];
                if (formToCCs[e.name] === undefined) {
                  continue;
                }
                if (e.type == "radio") {
                  if (!e.checked) {
                    continue;
                  }
                }
                var ccNum = formToCCs[e.name];
                var val = e.value;
                console.log(e.name + ": [" + status + ", " + ccNum + ", " + val + "]");

                var midiOut = midi.outputs[selectedPort.text];
                console.log(midiOut);
                midiOut.send([status, ccNum, val]);

            }

            return false;
          }
        );

        $("#share").button().click(
          function(event) {
            var params = "?";
            //console.log(event);
            var f = document.forms["editor"];
            for (var i = 0; i < f.elements.length; i++) {
                var e = f.elements[i];
                if (formToCCs[e.name] === undefined) {
                  continue;
                }
                if (e.type == "radio") {
                  if (!e.checked) {
                    continue;
                  }
                }
                var val = e.value;
                params += e.name+"="+e.value+"&";
            }
            params = params.substr(0, params.length - 1);
            

            var uri = document.documentURI;
            var queryStart = uri.indexOf("?")
            if (queryStart != -1) {
              uri = uri.substr(0, queryStart);
            }

            var shareUrl = uri + params;
            //console.log(shareUrl);

            $("#shareUrl").empty();
            $("#shareUrl").dialog({
              width: 760,
              height: 140,
              modal: true,
              position: { my: "center top", at: "left bottom", of: $("#share") }
            }).append('<p><b><a href="' + shareUrl + '">patch link</a></b> &lt;&lt; bookmark to save, copy to share</p><p>raw URL &gt;&gt; <i>'+ shareUrl + '</i></p>');
            

            return false;
          }
        );

        //$("#ports").selectmenu();
    });
</script>
  </div>

</body>
</html>